from dash import dcc, html, register_page


register_page(
    __name__,
    path="/reports/full-ue",
    name="Текстовый отчет по юнит-экономике",
    title="Отчеты - Текстовый отчет по юнит-экономике",
    order=150,
)


REPORT_MD_UE = """
# Всесторонний отчет по юнит-экономике

## 1. Охват раздела
Этот раздел проекта посвящен юнит-экономике онлайн-школы программирования X. На этом этапе мы исходим из уже очищенных данных (Deals, Contacts, Calls, Spend в `data/clean`) и отвечаем на вопросы:
- насколько текущая бизнес-модель окупается в среднем по бизнесу и по ключевым продуктам;
- какие метрики юнит-экономики являются точками роста;
- какие изменения в показателях (UA, C1, CPA, AOV, APC) больше всего влияют на маржинальную прибыль;
- какую гипотезу по росту (через улучшение C1) имеет смысл проверять и хватит ли нам трафика для A/B-теста.

Все расчеты юнит-экономики реализованы в модуле `src.analytics_ue`, а визуальная часть вынесена в блок страниц `/product/*`.

---

## 2. Базовые метрики и юнит-экономика (`/product/unit-economics`)

### 2.1 Что считаем
В модуле `src.analytics_ue` мы переходим от сырых полей CRM к набору бизнес-метрик юнит-экономики:
- UA - количество уникальных лидов (контактов), которые вошли в воронку;
- B - количество клиентов (сделки со стадией `payment done`);
- AC - маркетинговый бюджет (общий Spend из таблицы Spend);
- T - количество транзакций (например, месяцев обучения по сделкам);
- Revenue - суммарная выручка, рассчитанная через промежуточную метрику `R_I` для каждой сделки;
- C1 = B / UA - конверсия из лида в клиента;
- CPA = AC / UA - стоимость привлечения потенциального клиента (на одного лида);
- CAC = AC / B - стоимость привлечения клиента;
- AOV - средний чек (выручка на одну транзакцию);
- APC - среднее количество транзакций на клиента;
- CLTV - средняя валовая прибыль на одного клиента;
- LTV - средняя валовая прибыль на «юнит масштабирования» (например, на одного лида);
- CM = UA * (LTV - CPA) - маржинальная прибыль.

Для оценки Revenue используется формула на уровне отдельной сделки:
- сначала считаем «индивидуальный» средний чек AOV_I с учетом первоначальной оплаты и растянутой части (`Offer Total Amount`, `Initial Amount Paid`, `Course duration`, `Months of study`);
- затем выручка по сделке R_I = AOV_I * Months of study;
- общая выручка Revenue - сумма R_I по всем сделкам.

Все эти метрики агрегируются:
- по бизнесу в целом;
- по каждому ключевому продукту (например, `Web Developer`, `Digital Marketing`, `UX/UI Design`).

### 2.2 Как это видно в дашборде
На странице `/product/unit-economics` (файл `unit_economics.py`):
- верхний блок - таблица «Юнит-экономика по бизнесу в целом», где для каждой метрики отображается код (UA, B, AC, …) и человекочитаемое название;
- нижний блок - таблица «Юнит-экономика по продуктам», где те же показатели представлены в разрезе ключевых программ.

Таким образом, этот экран отвечает на вопрос: «В среднем, при текущем трафике и ценах, бизнес окупается или нет, и какие продукты вносят основной вклад в юнит-экономику?».

---

## 3. Точки роста юнит-экономики (`/product/growth-points`)

### 3.1 Логика сценариев роста
В модуле `src.analytics_ue` реализована функция `growth_scenarios_table`, которая строит таблицу сценариев изменения маржинальной прибыли CM при малых изменениях ключевых рычагов:
- UA - количество лидов;
- C1 - конверсия из лида в клиента;
- CPA - стоимость привлечения лида (для нее рассматривается снижение);
- AOV - средний чек;
- APC - среднее число транзакций на клиента.

Для каждого сегмента (бизнес целиком и каждый продукт) моделируются сценарии вида:
- «увеличить UA на +10 %»;
- «повысить C1 до целевого уровня (+10 %)»;
- «снизить CPA на 10 %»;
- «увеличить AOV на 10 %»;
- «увеличить APC на 10 %».

По каждому сценарию пересчитывается новая CM и сравнивается с базовым значением:
- CM_base - исходная маржинальная прибыль;
- CM_new - маржинальная прибыль после изменения одной метрики;
- CM_delta и CM_delta_% - абсолютный и относительный прирост.

### 3.2 Как это показано на странице
На странице `/product/growth-points`:
- первый блок показывает сценарии роста CM для бизнеса в целом (Segment = Business);
- второй блок - сценарии для отдельных продуктов.

Таблицы подсвечивают строки с максимальным приростом CM, чтобы сразу было видно:
- какой рычаг (UA, C1, CPA, AOV, APC) дает наибольший эффект в деньгах;
- по каким продуктам влияние этого рычага особенно сильное.

Таким образом, раздел «Growth Points» переводит язык юнит-экономики в конкретные «точки роста», с которыми можно идти к маркетингу и продукту.

---

## 4. Дерево метрик (`/product/metric-tree`)

### 4.1 Смысл дерева метрик
Отдельный модуль и страница `/product/metric-tree` визуализируют, как высокоуровневые показатели (например, CM или LTV) раскладываются на более простые составляющие:
- CM зависит от LTV и CPA;
- LTV зависит от CLTV и конверсии C1;
- CLTV складывается из AOV и APC;
- AOV и APC «поддерживаются» продуктовой и маркетинговой аналитикой (цены, продуктовый микс, длительность обучения и т.д.).

Идея: вместо того чтобы говорить «нам нужно увеличить CM», мы показываем, через какие конкретные метрики это может быть достигнуто и какие блоки воронки за них отвечают.

### 4.2 Как это выглядит в интерфейсе
На странице дашборда дерево отображается в виде структурированного блока: узлы (CM, LTV, CLTV, AOV, APC, C1, UA, AC, T, Revenue) и связи между ними. В таблицах под деревом можно видеть:
- описание каждой метрики;
- ее роль в общей формуле;
- краткий комментарий, за какой командой/процессом стоит улучшение этой метрики (маркетинг, продажи, продукт).

Этот раздел помогает объяснить юнит-экономику не только аналитикам, но и менеджерам: видно, какие показатели - результат, а какие - инструменты для роста.

---

## 5. Гипотезы и HADI-цикл (`/product/hypotheses`)

### 5.1 HADI-таблица по C1
Модуль `src.analytics_ue` содержит HADI-таблицу `hadi_table`, где разобрана примерная гипотеза по росту конверсии C1 (B / UA):
- H (гипотеза): если сократить SLA (время первого контакта с лидом) до 24 часов, то конверсия C1 вырастет до целевого уровня (10 %);
- A (действия): описаны шаги, как именно менять процесс (автоматические задачи, напоминания, скрипты);
- D (данные): какие именно метрики считаем по группам (C1, SLA, промежуточные конверсии);
- I (интерпретация): когда гипотеза считается подтвержденной и что делать дальше.

На странице `/product/hypotheses` HADI-таблица выводится отдельной таблицей, чтобы можно было обсуждать гипотезу в одном экране с числовой проверкой.

### 5.2 Проверка гипотезы: достаточно ли трафика
Функция `hypothesis_check_info` в `src.analytics_ue` рассчитывает параметры для проверки гипотезы по C1:
- текущая конверсия C1 (p_base) и целевая конверсия (target);
- абсолютный эффект x = target - p_base, который мы хотим заметить;
- требуемый размер выборки n_per_group для A/B-теста (по стандартной формуле для пропорций);
- текущий трафик UA/день и сколько лидов можно набрать за 14 дней (`n_available`);
- сколько дней нужно, чтобы набрать достаточный объем (`days_required`) и укладываемся ли в лимит 14 дней.

На странице `/product/hypotheses` это отображается в виде таблицы:
- по бизнесу в целом;
- по отдельным продуктам.

Дополнительно внизу есть блок с примером расчета: из каких чисел получается требуемый объем выборки, как считается минимально обнаружимый эффект и как это связано с текущим трафиком.

---

## 6. Основные выводы по юнит-экономике

1. **Все расчеты юнит-экономики опираются на очищенные данные.** Весь модуль `src.analytics_ue` использует только таблицы из `data/clean`, которые прошли импорт и очистку. Это позволяет доверять итоговым UE-метрикам.
2. **Юнит-экономика считается как по бизнесу в целом, так и по продуктам.** Мы видим не только «среднюю температуру», но и вклад отдельных программ, что важно для продуктовой стратегии.
3. **Точки роста привязаны к конкретным метрикам.** Сценарии роста CM показывают, за счет каких рычагов (UA, C1, CPA, AOV, APC) можно получить наибольший эффект - и для бизнеса в целом, и для конкретных программ.
4. **Дерево метрик делает модель понятной неаналитикам.** Вместо формул «на бумаге» дерево и подписи объясняют, из чего складывается CM и какие команды могут повлиять на каждую из метрик.
5. **HADI-цикл помогает перейти от аналитики к действиям.** Гипотеза по C1 и расчеты для A/B-теста показывают, как использовать юнит-экономику на практике: что именно тестировать, какой трафик нужен и какие результаты считать успехом.

Этот отчет можно рассматривать как текстовую «легенду» к разделу `/product/*`: он объясняет, какие таблицы и модули стоят за юнит-экономикой, какие метрики считаются и как по ним принимаются решения.
"""


def layout():
    from .sidebar import get_sidebar

    return html.Div(
        style={"display": "flex", "gap": "16px"},
        children=[
            get_sidebar(),
            html.Article(
                [
                    dcc.Markdown(REPORT_MD_UE),
                ],
                className="viz-card",
            ),
        ],
    )
