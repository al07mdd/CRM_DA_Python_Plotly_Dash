from dash import dcc, html, register_page


register_page(
    __name__,
    path="/reports/full",
    name="Текстовый отчет Python DA",
    title="Отчеты - Текстовый отчет Python DA",
    order=140,
)


REPORT_MD = """
# Всесторонний отчет по Python DA

## 1. Охват проекта
Этот финальный проект про полный цикл аналитики CRM для онлайн‑школы программирования. Мы получем четыре таблицы (Contacts, Calls, Deals, Spend), очищаем их в Python и показываем результаты только в Dash (`dash-app/`)

---

## 2. Страницы подготовки данных

### 2.1 Проверка импорта (`/data/import`)
`src.simple_import` читает все файлы через `src.io.load_table`, проверяет кодировки, наличие столбцов, количество строк и столбцов, а также количество пропусков по каждому столбцу. Итоги записываются в `reports/import_checklist.{json,md}` и выводятся на странице `import_validation.py`

### 2.2 Примечания по очистке (`/data/cleaning`)
`src.cleaning.run_cleaning` приводит типы (даты, bool, категории), убирает лишние пробелы, нормализует справочники и пересчитывает признаки (`is_paid`, длительность сделки - `deal_lifetime_days`, время до первого звонка - `lead_to_first_call_sla_hours`). Все логируется в `reports/step2_eda_summary.{json,md}` и показывается на странице `cleaning_preparation.py`

### 2.3 Описательная статистика (`/data/descriptive`)
`src.analytics_descriptive` берет очищенные parquet-файлы и считает сводные статистики по числовым полям (среднее, медиана, минимум/максимум), а также распределения по категориям `Quality`, `Stage`, `Source`, `Product`. Это помогает убедиться, что очищенная схема данных соответствует ожиданиям перед тем, как переходить к аналитике

---

## 3. Страницы анализа Python DA

### 3.1 Анализ временных рядов (`/viz/timeseries`)

Процесс:(src.analytics_timeseries)

1. `load_deals_calls` загружает очищенные Deals и Calls

2. `make_daily_series` агрегирует дневные создания сделок, количество звонков и конверсию

3. `make_closed_daily` считает, сколько сделок дошли до `Stage="payment done"` по дням

4. `make_ttc_series` и `ttc_hist_counts` рассчитывают распределения time-to-close (для всех сделок и отдельно для оплаченных)

5. Страница Dash, с учетом выбранного месяца, запускает ETL и показывает:
- двухлинейный график: созданные сделки и звонки, плюс субплот с конверсией;
- тренд закрытых сделок;
- сводную таблицу (итоги, средние значения в день);
- box plot для вариативности дневных значений;
- гистограмму time-to-close (общие и оплаченные);
- блок примечаний с датами, конверсией, медианой/p90 TTC, статистиками по длительности звонков.

Трактовка: 
мы видим динамику обработки лидов, изменения в активности отдела продаж, моменты роста или падения звонков и скорость закрытия сделок. Фильтр по месяцам дает возможность изучать конкретные периоды

### 3.2 Анализ эффективности кампаний и источников (`/viz/campaigns`)

Процесс:(src.analytics_campaigns)

1. `load_campaign_data` объединяет Deals и Spend по `campaign/source`

2. `compute_all_metrics` и `funnel_table` формируют этапы воронки (показы -> клики -> лиды -> оплаченные) и метрики по источнику/кампании/группе объявлений:
- leads, paid, конверсия, CPL/CPA, ROAS, выручка

3. На странице Dash исходные таблицы хранятся в dcc.Store, чтобы не перезагружать данные при каждом изменении фильтра

4. Пользователь может отфильтровать данные по источнику, кампании или adgroup. Страница обновляет:
- референсную воронку и воронку после фильтра
- таблицу ROAS и scatter-графики (Spend vs. Paid, CPC vs. CR)
- глоссарий метрик CTR/CPL/CPA и др.
- таблицу метрик (по источникам, кампаниям или adgroup)

Трактовка:
можно понять, какие каналы окупаются, где бюджет работает лучше, какие кампании дают высокий CPL или низкую конверсию и куда стоит перераспределять средства

### 3.3 Анализ работы отдела продаж (`/viz/sales`)

Процесс:(src.analytics_sales)

1. `_prepare_with_calls` соединяет Deals и Calls через контакт (`CONTACTID <--> Deals:contact_id`). Каждая сделка получает количество звонков, время первого звонка и метрики

2. `owner_metrics` группирует показатели по менеджерам (Deal Owner Name):
- `calls_cnt_total` - общее число звонков
- `n_processed` - количество обработанных сделок (есть звонок или закрытая стадия)
- `calls_cnt_per_processed` - среднее число звонков на обработанную сделку
- конверсия, сумма оплат и др.

3. Визуализации Dash подчеркивают менеджеров с лучшими показателями обработки, быстротой первого контакта и эффективностью

Трактовка:
можно увидеть реальные паттерны работы менеджеров, выделяет лидеров и узкие места, сколько усилий нужно на сделку, как быстро она берется в работу и какие результаты приносит каждый сотрудник

### 3.4 Анализ платежей и продуктов (`/viz/payments`)

Процесс: (src.analytics_payments)

1. `load_deals_for_payments` читает очищенные сделки из `data/clean/Deals.parquet`/`Deals.csv`, приводит даты к одному формату и добавляет вспомогательный столбец `month` по дате создания сделки.

2. `payment_product_metrics` группирует сделки по комбинации **типа оплаты (`Payment Type`)**, **продукта (`Product`)** и **формата обучения (`Education Type`)**. 

3. Страница Dash использует три основных показателя: выручка (`revenue_total`), количество сделок (`n_deals`) и количество оплаченных сделок (`n_paid`). 
   - работает с ограниченным набором ключевых продуктов (`Web Developer`, `Digital Marketing`, `UX/UI Design`).
На основе отфильтрованных данных строится одна интерактивная treemap-диаграмма, где размер и цвет прямоугольников отражают выбранный показатель.

Трактовка:
страница показывает, как распределяются сделки и выручка между разными продуктами и форматами оплаты. По ней можно увидеть:
- какие сочетания «тип оплаты + продукт» дают наибольший вклад в выручку;
- где много сделок, но относительно мало оплаченных (если сравнивать `n_deals` и `n_paid`);
- как меняется структура выручки и объема сделок при переключении периода и выбранной метрики.

### 3.5 Географический анализ (`/viz/geo`)

Процесс: (src.analytics_geo)

1. `load_deals` читает Deals, а `load_city_coords` подгружает координаты городов (`data/temp/city_coords.parquet`)

2. города без координат получают данные из `MANUAL_COORDS`

3. `city_options`, `make_city_summary` и `make_level_city_summary` считают количество сделок, выручку и конверсию по городам и уровню языка

4. на странице отображаются карты (+ scatter) с итогами по городам

Трактовка:
карта помогает понять географию спроса, где концентрируются лиды и оплаты, какие города показывают лучшую конверсию, где есть точки роста

---

## 4. Раздел отчетов (`/reports/*`)
- `report_full.py` - всесторонний отчет по Python DA
- `report_full_ue.py` - всесторонний отчет по юнит-экономике
- `presentation_final.py` - финальная презентация по Python DA

Все страницы используют уже посчитанные данные; новых расчетов там нет

---

## 5. Основные выводы
1. **Рабочий процес воспроизводим.** Импорт, очистка, описательная статистика фиксируются в отчетах и доступны в Dash
2. **Dash покрывает весь операционный контур.** Лиды, звонки, кампании, продажи, платежи, география - все в одном интерфейсе
3. **Логика связей прозрачна.** Звонки привязываются к сделкам по контакту, кампании - по названию и источнику; это задокументировано в `DATA_SCHEMA.md`
4. **Фильтры и кнопки обновления держат данные актуальными.** Импорт и Time Series можно пересчитать прямо из UI, чтобы подтянуть свежие выгрузки
5. **Вся аналитика сосредоточена в `src/analytics_*`.** Dash лишь визуализирует готовые результат, поэтому понимать отчет можно, опираясь на описание модулей
"""


def layout():
    from .sidebar import get_sidebar

    return html.Div(
        style={"display": "flex", "gap": "16px"},
        children=[
            get_sidebar(),
            html.Article(
                [
                    dcc.Markdown(REPORT_MD),
                ],
                className="viz-card",
            ),
        ],
    )
