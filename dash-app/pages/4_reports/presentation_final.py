from dash import html, register_page


register_page(
    __name__,
    path="/reports/presentation-final",
    name="Финальная презентация проекта",
    title="Final Project - Финальная презентация",
    order=160,
)


def _slide(title: str, paragraphs: list[str], image_name: str | None = None) -> html.Article:
    children: list[html.Component] = [html.H3(title)]
    for p in paragraphs:
        children.append(html.P(p))
    if image_name:
        children.append(
            html.Img(
                src=f"/assets/presentation/{image_name}",
                alt=title,
                style={
                    "display": "block",
                    "maxWidth": "900px",
                    "width": "100%",
                    "margin": "12px auto 0",
                    "borderRadius": "12px",
                },
            )
        )
    return html.Article(children, className="viz-card")


def layout():
    from .sidebar import get_sidebar

    slides = [
        _slide(
            "Контекст и цель проекта",
            [
                "Заказчик - онлайн-школа программирования X, которая ведет учет лидов и сделок в CRM.",
                "Исходная проблема: данные разбросаны по выгрузкам Contacts, Calls, Deals и Spend, качество выгрузок нестабильно, нет единой управленческой отчетности.",
                "Цель: построить воспроизводимый рабочий процес Python DA и дашборд Dash, который отвечает на ключевые вопросы маркетинга и отдела продаж.",
            ],
            "01_intro.png",
        ),
        _slide(
            "Данные и структура CRM",
            [
                "В проекте используются четыре основные таблицы: Contacts, Calls, Deals и Spend.",
                "Contacts - хранит информацию о контактах (Id, ответственный менеджер, время создания и обновления, город, уровень языка, страница обращения).",
                "Calls - содержит историю звонков и ссылается на контакты через поле CONTACTID, что позволяет считать активность по каждому лиду и сделке.",
                "Deals - описывает сделки, связывает их с контактами и продуктами и фиксирует этап воронки, суммы и формат обучения.",
                "Spend - хранит рекламные расходы по источникам и кампаниям, которые затем сопоставляются с полями Source/Campaign/AdGroup в Deals.",
                "Структура и связи подробно описаны в DATA_SCHEMA.md; сырые данные из `data/raw` не попадают в репозиторий и используются только локально.",
            ],
        ),
        _slide(
            "Общий рабочий процес Python DA",
            [
                "Шаг 1 - импорт: src.simple_import через src.io.load_table читает выгрузки Contacts, Calls, Deals, Spend, проверяет схему и качество данных и формирует отчёт `reports/import_checklist.*`.",
                "Шаг 2 - очистка: src.cleaning приводит типы, нормализует категории, убирает шум и создаёт ключевые признаки (флаг оплаты, длительность сделки, SLA до первого контакта и др.), результат - parquet-файлы в `data/clean`.",
                "Шаг 3 - аналитика: модули src.analytics_* строят метрики и визуализации для разных задач (описательная статистика, временные ряды, кампании, продажи, платежи, география, юнит-экономика).",
                "Шаг 4 - визуализация: Dash-приложение (`dash-app/`) подключает эти визуализации и отображает их в разделах /data, /viz, /product и /reports для презентации результатов.",
            ],
        ),
        _slide(
            "Контроль импорта и очистки",
            [
                "Страница `/data/import` показывает, какие файлы загружены, сколько в них строк и столбцов, и какова доля пропусков по каждому полю.",
                "Страница `/data/cleaning` фиксирует все шаги очистки: какие преобразования выполнены, какие признаки добавлены и какие решения приняты по аномалиям и дубликатам.",
                "Эти два экрана дают прозрачность качества данных до того, как мы переходим к аналитике и визуализации.",
            ],
            "04_import_cleaning.png",
        ),
        _slide(
            "Временные ряды и воронка во времени",
            [
                "Раздел `/viz/timeseries` показывает, как во времени ведут себя основные показатели: сколько сделок создается, сколько совершается звонков и как меняется конверсия.",
                "Отдельные графики отражают, когда сделки доходят до оплаты и как распределено время до закрытия (time-to-close) для разных периодов.",
                "Фильтрация по месяцам позволяет сравнивать динамику до и после изменений во воронке или запусков кампаний.",
            ],
            "05_timeseries.png",
        ),
        _slide(
            "Эффективность кампаний и источников",
            [
                "Раздел `/viz/campaigns` объединяет Deals и Spend и считает воронку и ключевые маркетинговые метрики: CPL, CPA, ROAS, конверсию из лида в оплату.",
                "Фильтры по источнику, кампании и adgroup позволяют сравнивать сегменты между собой и видеть, как меняются показатели при смене фокуса.",
                "На основе этих метрик можно понять, какие каналы и кампании стоит масштабировать, а какие - оптимизировать или выключать.",
            ],
            "06_campaigns.png",
        ),
        _slide(
            "Работа отдела продаж",
            [
                "Раздел `/viz/sales` соединяет сделки и звонки и показывает, как менеджеры работают с лидами: сколько звонков приходится на одну обработанную сделку, как быстро происходит первый контакт и какие результаты по оплатам у каждого менеджера.",
                "Показатели считаются по каждому сотруднику, поэтому можно выделить сильных исполнителей и узкие места в процессе обработки лидов.",
                "Эта страница служит основой для управленческих решений по SLA, нагрузке и качеству работы команды продаж.",
            ],
            "07_sales.png",
        ),
        _slide(
            "Платежи и продуктовый портфель",
            [
                "Раздел `/viz/payments` анализирует сделки по продуктам, форматам оплаты и типам обучения.",
                "Treemap-диаграмма показывает, как распределяются сделки и выручка между различными комбинациями «тип оплаты - продукт - формат обучения».",
                "По этой странице можно оценить структуру продуктового портфеля, долю ключевых программ и влияние форматов оплаты на итоговый результат.",
            ],
            "08_payments.png",
        ),
        _slide(
            "География спроса",
            [
                "Раздел `/viz/geo` показывает карту с количеством сделок, оплат и конверсией по городам и уровням языка.",
                "Гео-аналитика помогает понять, где сконцентрирован спрос, какие регионы растут быстрее и где есть потенциал для локальных активностей.",
                "Эти выводы можно использовать для настройки региональных кампаний и офлайн-инициатив.",
            ],
            "09_geo.png",
        ),
        _slide(
            "Итоги и следующие шаги",
            [
                "Построен воспроизводимый пайплайн: при новой выгрузке из CRM достаточно обновить файлы в `data/raw` и запустить скрипты - дашборд обновится автоматически.",
                "Дашборд отвечает на ключевые вопросы: как устроена воронка во времени, какие источники и кампании окупаются, как работает отдел продаж, какие продукты и форматы оплаты дают основную выручку и где географические точки роста.",
                "Следующие шаги: развитие блока unit economics, добавление оповещений по SLA и автоматизация обновления данных по расписанию.",
            ],
            "10_summary.png",
        ),
    ]

    return html.Div(
        style={"display": "flex", "gap": "16px"},
        children=[
            get_sidebar(),
            html.Div(
                style={"flex": 1, "display": "flex", "flexDirection": "column", "gap": "16px"},
                children=slides,
            ),
        ],
    )
